# DXF Label Diff

複数のDXFファイルペアからテキストラベルを抽出し、その差分をExcel形式で比較・出力するStreamlitアプリケーションです。

## 機能

- **複数ペア比較**: 最大5ペアのDXFファイルを同時に比較
- **ラベル抽出**: DXFファイルからTEXT、MTEXTエンティティを抽出
- **機器符号フィルタリング**: 回路記号（機器符号）のみを抽出する高度なフィルタリング
- **妥当性チェック**: 標準フォーマットとの適合性をチェック
- **Excel出力**: 色分けされた比較結果をExcel形式で出力
- **自動集計**: ペアごとの個別シートとサマリーシートを生成

## インストール

### ローカル開発環境

1. このリポジトリをクローンまたはダウンロード
2. 依存関係をインストール:
   ```bash
   pip install -r requirements.txt
   ```
3. アプリケーションを実行:
   ```bash
   streamlit run app.py
   ```

### Streamlit Cloud へのデプロイ

1. このリポジトリをGitHubにプッシュ
2. Streamlit Cloudに接続
3. 以下の設定でデプロイ:
   - **メインファイルパス**: `app.py`
   - **Pythonバージョン**: 3.9以上
   - **要件ファイル**: `requirements.txt`

## 使用方法

### 基本的なワークフロー

1. **ファイルペアの登録**: 最大5ペアのDXFファイルをアップロード
   - 各ペアは「DXFファイルA」と「DXFファイルB」で構成
   - 識別しやすいようにペアごとに名前を設定可能

2. **オプション設定** (任意):
   - **機器符号フィルタリング**: 回路記号のみを抽出
     - 基本パターン: `CNCNT`, `FB`
     - 英文字+数字: `R10`, `CN3`, `PSW1`
     - 英文字+数字+英文字: `X14A`, `RMSS2A`
     - 括弧付きパターン: `FB()`, `MSS(MOTOR)`, `R10(2.2K)`
   - **機器符号妥当性チェック**: 標準フォーマットとの適合性をチェック
   - **並び替え**: 昇順、降順、並び替えなしを選択

3. **ファイル処理**: 「ラベル差分を比較」ボタンをクリックして比較開始

4. **結果のダウンロード**: Excelファイルをダウンロード

### 出力ファイル

各比較により生成されるExcelファイル名: `(最初のペアのA)_vs_(最初のペアのB)_labels.xlsx`

Excelファイルの構成:
- **各ペアシート**: 個別の比較結果
  - ファイルAのみ存在: 赤色でハイライト
  - ファイルBのみ存在: 青色でハイライト
  - 両方に存在するが数が異なる: 黄色でハイライト
- **サマリーシート**: 全ペアの概要
- **Invalid シート** (妥当性チェック有効時): 適合しない機器符号一覧

## 技術詳細

### 対象となるDXFエンティティ

- **TEXT**: 単行テキスト
- **MTEXT**: 複数行テキスト（フォーマットコード除去処理付き）
- **ATTRIB**: 属性テキスト

### 機器符号フィルタリング

以下のパターンに一致するラベルを機器符号として認識:

1. **英文字のみ** (2文字以上): `FB`, `CNCNT`
2. **英文字+数字**: `R10`, `CN3`, `PSW1`
3. **英文字+数字+英文字**: `X14A`, `RMSS2A`
4. **括弧付きバリエーション**: `FB()`, `MSS(MOTOR)`, `R10(2.2K)`, `U23B(DAC)`

### 機器符号妥当性チェック

標準的な機器符号パターンとの適合性をチェック:
- **CB系**: `CB001`, `ELB(CB)001`, `MCCB001`, `NFB001`
- **基本部品**: `R`, `R1`, `C1`, `L1`, `Q1`
- **IC**: `U`, `U1`, `U10A`
- **電源**: `PS`, `PSW`, `DC1`, `AC1`
- **モータ**: `M`, `M1`, `MOT1`
- **リレー**: `K`, `K1`, `MC1`
- **スイッチ**: `S`, `S1`, `SW1`, `PB1`
- **表示**: `H`, `H1`, `HL1`, `PL1`
- **端子**: `X`, `X1`, `CN1`, `TB1`

### 高度な機能

1. **MTEXTフォーマット処理**:
   - フォーマット制御コード (`\f`, `\H`, `\W`, `\C` など) を自動除去
   - 日本語環境での円マーク (`¥`) とバックスラッシュ (`\`) の正規化
   - テキスト構造 (`\P`) は保持

2. **高精度テキスト抽出**:
   - 複数行テキストの正確な処理
   - エスケープ文字の適切な処理
   - 属性テキストの抽出

3. **柔軟な出力設定**:
   - カスタマイズ可能な出力ファイル名
   - 色分けされた差分表示
   - 統計情報の自動生成

## 依存関係

- **streamlit** >= 1.30.0: ウェブアプリケーションフレームワーク
- **ezdxf** >= 1.4.2: DXFファイルの読み書き
- **pandas** >= 1.5.0: データ分析・処理
- **xlsxwriter** >= 3.0.0: Excel ファイル生成

## システム要件

- Python 3.9 以上
- 最小 512MB RAM (一般的なDXFファイルの場合)
- JavaScriptが有効な最新のウェブブラウザ

## 制限事項

- セッションあたり最大5ファイルペア
- DXFファイルはezdxfライブラリで読み取り可能である必要があります
- 非常に大きなファイル (>100MB) はクラウドプラットフォームでメモリ問題を引き起こす可能性があります

## トラブルシューティング

### よくある問題

1. **「DXFファイルの読み取りエラー」**:
   - ファイルが有効なDXF形式であることを確認
   - ファイルが破損またはパスワード保護されていないか確認

2. **「ラベルが抽出されない」**:
   - TEXTまたはMTEXTエンティティが含まれているか確認
   - 機器符号フィルタリングが適切に設定されているか確認

3. **「処理タイムアウト」**:
   - 大きいまたは複雑なファイルは処理に時間がかかる場合があります
   - ファイルペアの数を減らしてみてください

4. **「機器符号が認識されない」**:
   - フィルタリングパターンを確認してください
   - 妥当性チェックを無効にして試してみてください

### サポート

技術サポートやバグレポートについては、アプリケーションログを確認するか、開発チームにお問い合わせください。

## ライセンス

このアプリケーションは 株式会社RDPi 所有であり特定顧客向けに開発されています。コピーや改版は禁止されています。

## バージョン履歴

- **v1.0.0**: 複数ペアDXFラベル比較機能を備えた初回リリース
  - 最大5ファイルペアのサポート
  - 機器符号フィルタリング機能
  - 機器符号妥当性チェック機能
  - Excel形式での色分け出力
  - 自動ファイル名生成